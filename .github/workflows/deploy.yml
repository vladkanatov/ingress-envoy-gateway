name: Deploy Envoy Gateway

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Verify cluster connection
        run: kubectl cluster-info

      - name: Deploy Helm chart
        run: |
          helm upgrade --install envoy-gateway . \
            -f values.yaml \
            --namespace envoy-gateway-system \
            --wait \
            --timeout 5m

      - name: Check deployment status
        run: |
          kubectl get pods -n envoy-gateway-system
          kubectl get gateway -n envoy-gateway-system
          kubectl get httproute -A
